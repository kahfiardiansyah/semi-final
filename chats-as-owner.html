<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat sebagai Pemilik - KerjaDi</title>
    <link href="bootstrap-5.3.8-dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .chat-item-compact {
            padding: 12px 15px;
            border: none;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        .chat-item-compact:hover {
            background-color: #f8f9fa;
            text-decoration: none;
        }
        .chat-avatar {
            width: 45px;
            height: 45px;
            object-fit: cover;
        }
        .chat-preview {
            font-size: 0.85em;
            max-width: 200px;
            color: #6c757d !important;
        }
        .unread-badge {
            width: 20px;
            height: 20px;
            font-size: 0.7em;
        }
        .page-header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 25px 0;
            margin-bottom: 30px;
        }
        .btn-outline-danger:hover {
            color: white;
        }
        .badge-owner {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand text-danger fw-bold" href="index.html">
                <i class="bi bi-building"></i> KerjaDi
            </a>
            <div class="d-flex align-items-center">
                <a href="inbox.html" class="btn btn-outline-danger btn-sm me-2">
                    <i class="bi bi-arrow-left"></i> Kembali ke Inbox
                </a>
                <div class="dropdown">
                    <button class="btn btn-light border rounded-pill" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" id="user-menu-items"></ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="h3 mb-0">
                        <i class="bi bi-buildings me-2"></i>Chat sebagai Pemilik
                    </h1>
                    <p class="mb-0 opacity-75">Kelola percakapan dengan penyewa properti Anda</p>
                </div>
                <div class="col-auto">
                    <span class="badge bg-light text-danger fs-6" id="chats-count">0 chat</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat List -->
    <div class="container">
        <div class="card shadow-sm border-danger">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-danger">
                        <i class="bi bi-people-fill me-2"></i>Percakapan dengan Penyewa
                    </h5>
                    <button class="btn btn-sm btn-outline-danger" onclick="loadOwnerChats()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="owner-chats-list" class="list-group list-group-flush">
                    <div class="text-center p-5">
                        <div class="spinner-border text-danger"></div>
                        <p class="mt-2 text-muted">Memuat percakapan...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="text-center mt-5" style="display: none;">
            <div class="bg-danger bg-opacity-10 rounded-circle p-4 d-inline-block mb-3">
                <i class="bi bi-buildings text-danger" style="font-size: 3rem;"></i>
            </div>
            <h4 class="text-muted">Belum ada percakapan</h4>
            <p class="text-muted">Penyewa akan menghubungi Anda melalui halaman properti</p>
            <a href="main.html" class="btn btn-danger">
                <i class="bi bi-eye me-2"></i>Lihat Properti Saya
            </a>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script>
        firebase.initializeApp(firebaseConfig);
        console.log('üî• Firebase initialized for owner chats page');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="bootstrap-5.3.8-dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/script.js"></script>
    
    <!-- Owner Chats Script -->
    <script>
        let currentUserId = null;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üì± Owner chats page loaded');
            initializeOwnerChats();
        });

        function initializeOwnerChats() {
            const auth = firebase.auth();
            
            auth.onAuthStateChanged(user => {
                if (!user) {
                    window.location.href = 'register.html';
                    return;
                }

                currentUserId = user.uid;
                console.log('‚úÖ User authenticated:', currentUserId);
                verifyOwnerRole();
            });
        }

        function verifyOwnerRole() {
            const db = firebase.firestore();
            
            db.collection('users').doc(currentUserId).get().then(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    const userRole = userData.role || 'user';
                    
                    if (userRole !== 'owner') {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Akses Ditolak',
                            text: 'Halaman ini hanya untuk pemilik properti.',
                            confirmButtonColor: '#dc3545'
                        }).then(() => {
                            window.location.href = 'inbox.html';
                        });
                        return;
                    }
                    
                    console.log('‚úÖ User is owner, loading chats...');
                    loadOwnerChats();
                }
            }).catch(error => {
                console.error('‚ùå Error verifying role:', error);
            });
        }

        function loadOwnerChats() {
            console.log('üì• Loading owner chats...');
            const db = firebase.firestore();
            const chatsContainer = document.getElementById('owner-chats-list');
            const emptyState = document.getElementById('empty-state');
            const chatsCount = document.getElementById('chats-count');

            // Show loading
            chatsContainer.innerHTML = `
                <div class="text-center p-5">
                    <div class="spinner-border text-danger"></div>
                    <p class="mt-2 text-muted">Memuat percakapan...</p>
                </div>
            `;
            emptyState.style.display = 'none';

            db.collection('chats')
                .where('participants', 'array-contains', currentUserId)
                .orderBy('lastMessageTimestamp', 'desc')
                .get()
                .then(querySnapshot => {
                    console.log('üì® Owner chats received:', querySnapshot.size);

                    if (querySnapshot.empty) {
                        showEmptyOwnerChats();
                        return;
                    }

                    renderOwnerChats(querySnapshot, chatsContainer, chatsCount);
                })
                .catch(error => {
                    console.error('‚ùå Error loading owner chats:', error);
                    showOwnerChatsError();
                });
        }

        function renderOwnerChats(snapshot, container, countElement) {
            let chatsHtml = '';
            const promises = [];
            let chatCount = 0;

            snapshot.forEach(doc => {
                const chat = doc.data();
                const chatId = doc.id;
                const otherUserId = chat.participants.find(id => id !== currentUserId);

                if (!otherUserId) return;

                const userPromise = firebase.firestore().collection('users').doc(otherUserId).get().then(userDoc => {
                    if (!userDoc.exists) return null;

                    const userData = userDoc.data();
                    const otherUserName = userData.name || 'Pengguna';
                    const otherUserPhoto = userData.photoURL || 
                        `https://ui-avatars.com/api/?name=${encodeURIComponent(otherUserName)}&background=random&color=fff`;
                    const otherUserRole = userData.role || 'user';

                    // HANYA tampilkan chat dengan penyewa (bukan owner)
                    if (otherUserRole === 'owner') return null;

                    const unreadCount = chat.unreadCount?.[currentUserId] || 0;
                    const lastMessageTime = chat.lastMessageTimestamp ? 
                        formatTime(chat.lastMessageTimestamp.toDate()) : '';

                    const lastMessage = chat.lastMessage || "Belum ada pesan";
                    const isMyMessage = chat.lastMessageSenderId === currentUserId;

                    const chatItem = `
                        <a href="chat.html?chatId=${chatId}" 
                           class="list-group-item chat-item-compact d-flex align-items-center ${unreadCount > 0 ? 'bg-light fw-bold' : ''}">
                            <img src="${otherUserPhoto}" class="rounded-circle chat-avatar me-3" 
                                 alt="${otherUserName}"
                                 onerror="this.src='https://ui-avatars.com/api/?name=User&background=random&color=fff'">
                            <div class="flex-grow-1">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1 d-inline">${otherUserName}</h6>
                                        <span class="badge badge-owner ms-2">Penyewa</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <small class="text-muted me-2">${lastMessageTime}</small>
                                        ${unreadCount > 0 ?
                                            `<span class="badge bg-danger rounded-pill unread-badge d-flex align-items-center justify-content-center">${unreadCount}</span>` : ''}
                                    </div>
                                </div>
                                <p class="mb-0 text-muted text-truncate chat-preview">
                                    ${isMyMessage ? 'Anda: ' : ''}${lastMessage}
                                </p>
                            </div>
                        </a>
                    `;

                    chatsHtml += chatItem;
                    chatCount++;
                    return { otherUserName, otherUserRole };
                }).catch(error => {
                    console.error('Error loading user data:', error);
                    return null;
                });

                promises.push(userPromise);
            });

            Promise.all(promises).then(() => {
                if (chatCount > 0) {
                    container.innerHTML = chatsHtml;
                    countElement.textContent = `${chatCount} chat`;
                    document.getElementById('empty-state').style.display = 'none';
                } else {
                    showEmptyOwnerChats();
                }
            });
        }

        function showEmptyOwnerChats() {
            document.getElementById('owner-chats-list').innerHTML = '';
            document.getElementById('empty-state').style.display = 'block';
            document.getElementById('chats-count').textContent = '0 chat';
        }

        function showOwnerChatsError() {
            const container = document.getElementById('owner-chats-list');
            container.innerHTML = `
                <div class="text-center p-5 text-danger">
                    <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                    <p class="mt-3">Gagal memuat percakapan</p>
                    <button class="btn btn-danger mt-3" onclick="loadOwnerChats()">
                        <i class="bi bi-arrow-clockwise me-2"></i>Coba Lagi
                    </button>
                </div>
            `;
        }

        function formatTime(date) {
            return date.toLocaleTimeString('id-ID', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Make function globally available
        window.loadOwnerChats = loadOwnerChats;
    </script>
</body>
</html>